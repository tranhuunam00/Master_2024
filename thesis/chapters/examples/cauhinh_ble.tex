\begin{lstlisting}[language=C,
caption={Chương trình thiết lập kết nối, truyền dữ liệu qua BLE},
label={lst:ble_bmi270},
escapeinside={(*@}{@*)}
]
const char* deviceServiceUuid = "19b10000-e8f2-537e-4f6c-d104768a1214";
const char* deviceServiceCharacteristicUuid = "19b10001-e8f2-537e-4f6c-d104768a1214";

BLEService accelerometerService(deviceServiceUuid);
BLECharacteristic accelerometerCharacteristic(
  deviceServiceCharacteristicUuid,
  BLERead | BLEWrite | BLENotify,
  9, 3
);
BMI270 imu;

void setup() {
  Serial.begin(9600);
  Serial.println("Started");
  Wire1.begin();

  if (!BLE.begin()) {
    Serial.println("- Starting Bluetooth Low Energy module failed!");
    while (1);
  }

  BLE.setLocalName("Master_2025_BLE");
  BLE.setDeviceName("Master_2025_BLE");
  BLE.setAdvertisedService(accelerometerService);

  accelerometerService.addCharacteristic(accelerometerCharacteristic);
  BLE.addService(accelerometerService);
  accelerometerCharacteristic.canSubscribe();
  accelerometerCharacteristic.subscribed();

  BLE.advertise();

  Serial.println("Nano 33 BLE (Peripheral Device)");

  **SETUP accelerometer**
}

static float x, y, z;

void loop() {
  BLEDevice central = BLE.central();
  Serial.println("- Discovering central device...");
  delay(500);

  if (central) {
    Serial.println("* Connected to central device!");
    Serial.print("* Device MAC address: ");
    Serial.println(central.address());
    while (central.connected()) {
      imu.getSensorData();
      x = imu.data.accelX;
      y = imu.data.accelY;
      z = imu.data.accelZ;

      Serial.print(x);
      Serial.print('\t');
      Serial.print(y);
      Serial.print('\t');
      Serial.println(z);

      uint8_t accelData[9] = {
        (x >= 0) ? 1 : 0,
        abs((int)x),
        abs((int)(x * 100) % 100),
        (y >= 0) ? 1 : 0,
        abs((int)y),
        abs((int)(y * 100) % 100),
        (z >= 0) ? 1 : 0,
        abs((int)z),
        abs((int)(z * 100) % 100)
      };

      accelerometerCharacteristic.writeValue(accelData, sizeof(accelData)); 
      delay(100); 
    }
  }
}

\end{lstlisting}
